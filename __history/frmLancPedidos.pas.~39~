unit frmLancPedidos;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Vcl.StdCtrls, Vcl.ExtCtrls, Data.DB,
  Vcl.Grids, Vcl.DBGrids, Vcl.Buttons, uDmConexao, ULancPedido, UClientes;

type
  TFrmPedidos = class(TForm)
    Panel1: TPanel;
    btn_excluir: TButton;
    btn_incluir: TButton;
    btn_pesquisar: TButton;
    btn_salvar: TButton;
    btn_cancelar: TButton;
    GroupBox1: TGroupBox;
    GroupBox2: TGroupBox;
    DBGrid1: TDBGrid;
    edt_NumPedido: TLabeledEdit;
    edt_CodCliente: TLabeledEdit;
    SpeedButton1: TSpeedButton;
    edt_NomeCliente: TLabeledEdit;
    edt_Vendedor: TLabeledEdit;
    edt_Total: TLabeledEdit;
    edt_Desconto: TLabeledEdit;
    edt_ValorPago: TLabeledEdit;
    edt_CodPedido: TLabeledEdit;
    procedure FormCreate(Sender: TObject);
    procedure btn_salvarClick(Sender: TObject);
    procedure btn_incluirClick(Sender: TObject);
    procedure btn_excluirClick(Sender: TObject);
    procedure edt_DescontoExit(Sender: TObject);
    procedure btn_cancelarClick(Sender: TObject);
    procedure btn_pesquisarClick(Sender: TObject);
    procedure SpeedButton1Click(Sender: TObject);
  private
    { Private declarations }
    LancPedido : TLancPedido;
    Clientes : TCadClientes;

    procedure LimparForm;

  public
    { Public declarations }
    Procedure Usuario;
  end;

var
  FrmPedidos: TFrmPedidos;

implementation

uses frmPesquisaGeral;

{$R *.dfm}

{ TFrmPedidos }



procedure TFrmPedidos.btn_cancelarClick(Sender: TObject);
begin
  LancPedido := TLancPedido.Create;

  LancPedido.Cancelar;
  btn_pesquisar.Click;

  LancPedido.Free;
end;

procedure TFrmPedidos.btn_excluirClick(Sender: TObject);
begin
  LancPedido := TLancPedido.Create;

  LancPedido.COD_PEDIDO := StrToInt(edt_CodPedido.Text);

  if Application.MessageBox('Você deseja excluir o registro? ', 'Aviso',
    MB_ICONQUESTION+MB_YESNO) = mrYes then
  begin
    LancPedido.Excluir;
    LancPedido.Free;
  end
  else
    Exit;

  LimparForm;
end;

procedure TFrmPedidos.btn_incluirClick(Sender: TObject);
begin
    if (edt_NumPedido.Text <> '') or (edt_CodCliente.Text <> '') or (edt_NomeCliente.Text <> '') then
  begin
    if Application.MessageBox('Você deseja incluir um novo registro? as alterações realizadas caso não salvar serão perdidas!',
    'Aviso', MB_ICONQUESTION+MB_YESNO) = mrNo then
    exit;
  end;
  LimparForm;
end;

procedure TFrmPedidos.btn_pesquisarClick(Sender: TObject);
begin
//  frmPesqGeral.Close;
//  uDmConexao.DataModule1.ADOQuery1.Close;
//  uDmConexao.DataModule1.ADOQuery1.Open;
//  frmPesqGeral.Show;
//  FrmPedidos.Close;
end;

procedure TFrmPedidos.btn_salvarClick(Sender: TObject);
begin
  LancPedido := TLancPedido.Create;


  LancPedido.NUMERO_PEDIDO_CLIENTE := StrToInt(edt_NumPedido.Text);
  LancPedido.COD_CLIENTE := StrToInt(edt_CodCliente.Text);
  LancPedido.NOME_CLIENTE := edt_NomeCliente.Text;
  LancPedido.VALOR_PEDIDO := StrToFloat(edt_Total.Text);
  LancPedido.DESCONTO_PAGO := StrToFloat(edt_Desconto.Text);
  LancPedido.VALOR_PAGO := StrToFloat(edt_ValorPago.Text);

  LancPedido.COD_USU := StrToInt(DataModule1.ID_Logado);

  if edt_CodPedido.Text <> '' then
  begin
    LancPedido.COD_PEDIDO := StrToInt(edt_CodPedido.Text);
    LancPedido.Editar
  end
  else
    LancPedido.Salvar;

  LancPedido.Free;
end;


procedure TFrmPedidos.edt_DescontoExit(Sender: TObject);
var
  ValorPago,Desconto, ValorTotal : Double;
begin
  ValorTotal := StrToFloatDef(edt_Total.Text, 0);
  Desconto := StrToFloatDef(edt_Desconto.Text, 0);

  ValorPago := ValorTotal - Desconto;
  edt_ValorPago.Text := FormatFloat('#0.00', ValorPago);
end;

procedure TFrmPedidos.FormCreate(Sender: TObject);
begin

  if frmPesqGeral.SPK <> '' then
  begin
    uDmConexao.DataModule1.ADOQuery1.Close;
    uDmConexao.DataModule1.ADOQuery1.SQL.Clear;
    uDmConexao.DataModule1.ADOQuery1.SQL.Text :=
    'select                                                             '+
    '       Ped.COD_PEDIDO,                                             '+
    '       Ped.NUMERO_PEDIDO_CLIENTE,                                  '+
    '       Cli.COD_CLIENTE,                                            '+
    '       Cli.NOME_CLIENTE,                                           '+
    '       Ped.VALOR_PEDIDO,                                           '+
    '       Ped.VALOR_PAGO,                                             '+
    '       Ped.DESCONTO_PEDIDO,                                        '+
    '       Usu.CD_USU,                                                 '+
    '       Usu.NOME_USU                                                '+
    'from Pedido Ped                                                    '+
    'inner join Clientes Cli on Cli.COD_CLIENTE  = Ped.COD_CLIENTE      '+
    'inner join Usuario Usu on Usu.CD_USU = Ped.COD_USU                 '+
    'WHERE COD_PEDIDO = '''+ frmPesqGeral.SPK +''' ';
    uDmConexao.DataModule1.ADOQuery1.Active := True;

    Self.Caption := Self.Caption + ' - Pedido: '+ DataModule1.ADOQuery1.FieldByName('COD_PEDIDO').AsString;

    edt_CodPedido.Text := DataModule1.ADOQuery1.FieldByName('COD_PEDIDO').AsString;
    edt_NumPedido.Text := DataModule1.ADOQuery1.FieldByName('NUMERO_PEDIDO_CLIENTE').AsString;
    edt_CodCliente.Text := DataModule1.ADOQuery1.FieldByName('COD_CLIENTE').AsString;
    edt_NomeCliente.Text := DataModule1.ADOQuery1.FieldByName('NOME_CLIENTE').AsString;
    edt_Total.Text := DataModule1.ADOQuery1.FieldByName('VALOR_PEDIDO').AsString;
    edt_ValorPago.Text := DataModule1.ADOQuery1.FieldByName('VALOR_PAGO').AsString;
    edt_Desconto.Text := DataModule1.ADOQuery1.FieldByName('DESCONTO_PEDIDO').AsString;
    edt_Vendedor.Text := DataModule1.ADOQuery1.FieldByName('NOME_USU').AsString;
    uDmConexao.DataModule1.ADOQuery1.Open;
  end;
end;



procedure TFrmPedidos.LimparForm;
begin
  edt_NumPedido.Clear;
  edt_CodCliente.Clear;
  edt_NomeCliente.Clear;
  edt_Total.Clear;
  edt_Desconto.Clear;
  edt_ValorPago.Clear;
  edt_Vendedor.Text := DataModule1.Usuario_Logado;
end;


procedure TFrmPedidos.SpeedButton1Click(Sender: TObject);
begin
//  uDmConexao.DataModule1.ADOQuery1.Close;
//  uDmConexao.DataModule1.ADOQuery1.SQL.Clear;
//  uDmConexao.DataModule1.ADOQuery1.SQL.Text :=
//  'select                                       '+
//  '    Cli.COD_CLIENTE,                         '+
//  '    Cli.NOME_CLIENTE,                        '+
//  '    Cli.IDADE,                               '+
//  '    Cli.SEXO,                                '+
//  '    uf.COD_UF,                               '+
//  '    uf.SIGLA                                 '+
//  '  from Clientes Cli                          '+
//  '  inner join UF uf on uf.COD_UF  = Cli.UF    '+
//  '  WHERE COD_CLIENTE = '''+frmPesqGeral.SPK +''' ';
//  uDmConexao.DataModule1.ADOQuery1.Active := True;


  frmPesqGeral:= frmPesqGeral.Create(Owner);
  frmPesqGeral.sTipoPesquisa := 'Clientes';
  frmPesqGeral.ShowModal;
  frmPesqGeral.SPK


end;

procedure TFrmPedidos.Usuario;
begin
  edt_Vendedor.Text := DataModule1.Usuario_Logado;
end;

end.
